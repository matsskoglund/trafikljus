<html>

<head>
</head>
<script src="http://koda.nu/simple.js">


  
  var timer = 0;
  var timerStarted = false;
  const FIRST_LANE_POS = 270
  const LANE_WIDTH = 170

  const DEBUG = true
  const TRAFFIC_START_POS = 250
  const WALKER_START_POS = 10
  const TRAFFIC_END_POS = 1110
  const WALKERS_END_POS = 1210
  const JAYWALKER_PERCENTAGE = 10
  const NORMAL_WALKSPEED = 4
  const LOWEST_TRAFFIC_SPEED = 3
  const TRAFFIC_TYPE_COUNT = 2
  const SHORTEST_TIME_BETWEEN_NEW_VECHICLE = 10
  const LANE_COUNT = 5
  const PEOPLE_DISTANCE = 40
  const PEOPLE_WAITING_TRIGGER = 25
  const SAFE_VEHICLE_DISTANCE = 120
  const BOARD_WALK_POSITION = 130
  const STOP_LINE_POSITION = 370
  var ticker = TRAFFIC_START_POS

  var carDistanceTimer = 100
  var generateCars = 0
  var generatePeople = 40
  var initiated = false
  var generateCarTimer = 0

  var cars = new Array()
  var people = new Array()
  var lanes = new Array()

  function update() {
    picture(0, 0, "http://koda.nu/bilder/iis/trafikljus/street.png", totalWidth, totalHeight);

    // Generate cars
    if (generateCarTimer == 0) {
      // Select a lane to generate car in at random
      laneIdx = random(5)

      // Create a new car
      newCar = {
        color: randomColor(),
        lane: laneIdx,
        vehicleType: random(TRAFFIC_TYPE_COUNT),
        speed: random(5) + LOWEST_TRAFFIC_SPEED,
        posX: TRAFFIC_START_POS
      };

      // Check if there already is a car in the beginning of the lane
      // In that case, don't add the
      var carInFront = false
      var p = 0
      while (carInFront == false && p < cars.length) {
        if ((newCar.posY == cars[p].posY) && (cars[p].posX - newCar.posX) < SAFE_VEHICLE_DISTANCE)
          carInFront = true
        p++
      }
      if (!carInFront)
        cars.push(newCar)

      generateCarTimer = random(10) + SHORTEST_TIME_BETWEEN_NEW_VECHICLE
    } else {
      generateCarTimer--
    }

    // Generate people if generatePeople timer has reached zero    
    if (generatePeople == 0) {
      newMan = generatePerson()
      generatePeople = random(30) + 20
    } else {
      generatePeople--
    }
    // Calculate number of people waiting
    peopleInLine = getPeopleWaitingCount()
    if (peopleInLine > PEOPLE_WAITING_TRIGGER)
      timerStarted = true

    // Move each person
    for (i = 0; i < people.length; i++) {
      // Find out if we should stop. If a person is about to run into a car she should stop
      // Loop through each car an
      stop = shouldStop(people[i])
      pif = isPersonInFront(people[i])

      if (people[i].jaywalker && (!stop) || walkOk(timer) || (people[i].posY < BOARD_WALK_POSITION && !pif) || (people[i].posY > BOARD_WALK_POSITION && (!stop)))
        people[i].posY += people[i].speed

      drawPerson(people[i])
    }


    // Draw cars
    for (i = 0; i < cars.length; i++) {
      // Find out if there is a vehicle in front so we can avoid running into it
      carInFront = getCarInFront(cars[i])
      if ((carInFront != null) && carInFront.speed < cars[i].speed)
        cars[i].speed = carInFront.speed

      if ((trafficRunning(timer) || (!trafficRunning(timer) && (cars[i].posX < STOP_LINE_POSITION)) || (cars[i].posX > STOP_LINE_POSITION))) {
        if (carInFront == null) {
          cars[i].posX += cars[i].speed
        } else if (cars[i].speed > carInFront.speed)
          cars[i].speed += carInFront.speed
      }
      if (cars[i].vehicleType == 0)
        drawSingelCar(cars[i])
      else
        drawSingelBike(cars[i])

      // If vehicle has reach end of screen then remove it
      if (cars[i].posX >= TRAFFIC_END_POS) {
        cars.splice(i, 1)
      }
    }

    // Press walk button
    if (keyboard.space) {
      timerStarted = true;
    }

    if (timerStarted == true) {
      timer += 1;
    }

    walkSign = getWalkSign(timer)
    trafficSign = getTrafficSign(timer)
    picture(totalWidth - 70, 0, trafficSign)
    picture(0, 0, walkSign)

    if (timer == 900) {
      timerStarted = false;
      timer = 0
    }

  }

  function getPeopleWaitingCount() {
    var peopleInLine = 0
    for (p = 0; p < people.length; p++) {
      if (people[p].posY < 130)
        peopleInLine++
    }
    return peopleInLine
  }

  function generatePerson() {

    // Generate a jayWalker if threshhold is above specified number
    var randomNumber = random(100)
    var jayWalker = false
    walkSpeed = NORMAL_WALKSPEED
    if (randomNumber > (100 - JAYWALKER_PERCENTAGE)) {
      jayWalker = true
      walkSpeed = 6
    }

    newMan = {
      color: randomColor(),
      lane: laneIdx,
      posY: WALKER_START_POS,
      posX: 520 + random(5) * 70,
      jaywalker: jayWalker,
      speed: walkSpeed
    };
    ////////
    var personInFront = false
    for (p = 0; p < people.length; p++) {
      if ((newMan.posX == people[p].posX) && (people[p].posY - newMan.posY) < PEOPLE_DISTANCE)
        personInFront = true
    }

    if (!personInFront)
      people.push(newMan)
  }
  function trafficRunning(timer) {
    if (timer < 60) {
      return true
    } else {
      return false
    }
  }

  function walkOk(timer) {
    if (timer >= 250 && timer < 520) {
      return true
    } else {

      return false
    }
  }


  function getTrafficSign(timer) {

    // Show yellow sign after a short while from button has been pressed and show it for 
    if ((timer > 60 && timer < 120) || (timer >= 800)) {
      return "http://koda.nu/bilder/iis/trafikljus/light_yellow.png"
    }

    // Show red sign after yellow sign and show it for 
    if (timer >= 120 && timer < 800) {
      return "http://koda.nu/bilder/iis/trafikljus/light_red.png"
    }
    return "http://koda.nu/bilder/iis/trafikljus/light_green.png"
  }

  function getWalkSign(timer) {
    if (timer >= 250 && timer < 520) {
      return "http://koda.nu/bilder/iis/trafikljus/walk_green.png"
    } else
      return "http://koda.nu/bilder/iis/trafikljus/walk_red.png"
  }

  function getLanePos(laneNo) {
    return FIRST_LANE_POS + LANE_WIDTH * laneNo
  }

  function drawSingelCar(car) {
    lanePos = getLanePos(car.lane)
    rectangle(car.posX, lanePos + 20, 80, 60, car.color)
    rectangle(car.posX + 50, lanePos + 30, 30, 30, "lightblue")
    circle(car.posX + 20, lanePos + 80, 13, "black")
    circle(car.posX + 60, lanePos + 80, 13, "black")
  }

  function drawPerson(man) {
    rectangle(man.posX + 53, man.posY + 5, 50, 28, man.color)
    rectangle(man.posX + 48, man.posY + 8, 62, 20, man.color)
    circle(man.posX + 78, man.posY + 20, 20, "black")
    circle(man.posX + 78, man.posY + 20, 10, "gray")
  }
  function drawSingelBike(car) {
    lanePos = getLanePos(car.lane)
    rectangle(car.posX + 10, lanePos + 40, 60, 20, car.color)
    rectangle(car.posX + 25, lanePos + 20, 30, 20, car.color)

    circle(car.posX + 20, lanePos + 60, 13, "black")
    circle(car.posX + 60, lanePos + 60, 13, "black")
  }

  function isPersonInFront(person) {
    var personInFront = false
    if (i > 0) {
      for (p = 0; p < people.length; p++) {
        if ((people[i].posX == people[p].posX) && (p < i) && (people[p].posY - people[i].posY) < 45)
          personInFront = true
      }
    }
    return personInFront
  }

  function shouldStop(person) {
    var j = 0
    while (j < cars.length) {
      carPosY = getLanePos(cars[j].lane)
      if ((carPosY > person.posY && (carPosY - person.posY) < SAFE_VEHICLE_DISTANCE) &&
        ((abs(person.posX - cars[j].posX)) < 350)) {
        // if ((person.posX > 500) && (person.jaywalker))
        //   person.posX -= 1
      }
      if ((carPosY > person.posY && (carPosY - person.posY) < 25) &&
        ((abs(person.posX - cars[j].posX)) < 120)) {
        return true
      }
      j++
    }
    return false
  }
  function getCarInFront(car) {
    var isCarInFront = false
    if (i > 0) {
      var p = 0
      while (p < cars.length && !isCarInFront) {
        if ((cars[i].lane == cars[p].lane) && (p < i) && (cars[p].posX - cars[i].posX) < 100) {
          return cars[p]
        }
        p++
      }
    }
    return null
  }

  function getSpeedOfCarInFront(car) {
    var isCarInFront = false
    if (i > 0) {
      var p = 0
      while (p < cars.length && !isCarInFront) {
        if ((cars[i].lane == cars[p].lane) && (p < i) && (cars[p].posX - cars[i].posX) < 100) {
          return cars[p].speed
        }
        p++
      }
    }
    return car.speed
  }
</script>


<body>
</body>

</html>