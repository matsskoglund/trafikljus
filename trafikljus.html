<html>
<head>
</head>
<script src="http://koda.nu/simple.js">

    
  var a = 60;
  var timer = 0;
  var timerStarted = false;
  const FIRST_LANE_POS = 270
  const LANE_WIDTH = 170
  const FIRST_WALKING_LANE_POS = 520
  const WALKING_LANE_WIDTH = 70

  const DEBUG = true
  const TRAFFIC_START_POS = 250
  const WALKER_START_POS = 10
  const TRAFFIC_END_POS = 1110
  const WALKERS_END_POS = 1210
  var ticker = TRAFFIC_START_POS
  var carDistanceTimer = 100
  var generateCars = 0
  var generatePeople = 40
  var initiated = false
  if(DEBUG)
    text (100, 200, 20, timer, "red")
  
  var cars = new Array()
  var people = new Array()
  var lanes = new Array()
  var peopleLanes = new Array()
 

  function update()
  {
    picture(0,0, "http://koda.nu/bilder/iis/trafikljus/street.png", totalWidth, totalHeight);
    picture()
    if(initiated == false)
    {
      // Generate traffic lanes
      for(laneIdx=0;laneIdx<5;laneIdx++){
        newLane={
          pos: FIRST_LANE_POS,
          laneIndex:laneIdx,
          generateCars:0            
        }
        lanes.push(newLane)
      }
      // Generate people lanes
      for(laneIdx=0;laneIdx<5;laneIdx++){
        newLane={
          pos: FIRST_WALKING_LANE_POS,
          laneIndex:laneIdx,
          generatePeople:0,
          people: Array()
        }
        peopleLanes.push(newLane)
      }
      initiated = true
    }
    // Generate cars for each lane
    for(laneIdx=0;laneIdx<5;laneIdx++){
      if((lanes[laneIdx].generateCars == 0) && (trafficRunning(timer))){
        newCar = {
          color:getRandomColor(), 
          lane:laneIdx, 
          vehicleType: random(2),
          posX:TRAFFIC_START_POS  
        }; 
        cars.push(newCar)
        lanes[laneIdx].generateCars = random(90)+50
      }else if (trafficRunning(timer)){
        lanes[laneIdx].generateCars--
      }
    }

    // Generate people
    // Create new person
    if(generatePeople == 0){
      
      var randomNumber = random(100)
      var jayWalker = false
      if(randomNumber >90)
        jayWalker = true
      newMan = {
            color:randomColor(),
            lane:laneIdx, 
            posY:WALKER_START_POS,
            posX: 520 + random(5)*70,
            jaywalker: jayWalker
          }; 
      people.push(newMan)
      generatePeople = random(60) + 30
    }else{
      generatePeople--
    }
    for(i=0;i<people.length;i++){
      // Find out if we should stop
      stop = false
      for(j=0;j<cars.length;j++){
        /*if(DEBUG)
          text (100, 200, 20, carLanePos, "black")*/
        carPosY = getLanePos(cars[j].lane)
       // text (cars[j].posX, carPosY-20, 20, people[i].posX - cars[j].posX, "blue")
        if( (carPosY > people[i].posY  && (carPosY - people[i].posY) < 25) &&
             ((abs(people[i].posX - cars[j].posX)) < 120) ) {
            stop = true
        }
      }
      var personInFront = false
      if(i > 0){
        for(p=0;p<people.length;p++){
          if((people[i].posX == people[p].posX) && (p<i) && (people[p].posY - people[i].posY)<45)
            personInFront = true
        }
      }

      if(people[i].jaywalker && (!stop) || walkOk(timer) || (people[i].posY < 130 && !personInFront) || (people[i].posY > 130 && (!stop)))
        people[i].posY += 4
      
      drawPerson(people[i])
    }
    // // Generate people
    // for(laneIdx=0; laneIdx <= 4; laneIdx++){    
    //   if((peopleLanes[laneIdx].generatePeople == 0) && (peopleLanes[laneIdx].people.length < 40)){
    //     newMan = {
    //       color:getRandomColor(), 
    //       lane:laneIdx, 
    //       pos:WALKER_START_POS,          
    //     }; 
        
    //     people.push(newMan)

    //     peopleLanes[laneIdx].people.push(newMan)
    //     peopleLanes[laneIdx].generatePeople = Math.floor(Math.random() * 60 + 30 )
    //   }else{
    //     peopleLanes[laneIdx].generatePeople--
    //   }
    // }
    
    // // Generate people
    // for(laneIdx=0; laneIdx <= 4; laneIdx++){    
    //   for(personIdx = 0; personIdx < peopleLanes[laneIdx].people.length; personIdx++){
    //     currentPerson = peopleLanes[laneIdx].people[personIdx]
        
    //      if(personIdx > 0){
    //        personInFront = peopleLanes[laneIdx].people[personIdx-1]
          
    //      }else  
    //        personInFront = null
    //     if(walkOk(timer) ||
    //     (currentPerson.pos < 130) && (personInFront == null) ||
    //     (currentPerson.pos < 130) && (personInFront != null) && ((personInFront.pos - currentPerson.pos) > 45)||
    //     currentPerson.pos > 130)
       
    //     {
    //       peopleLanes[laneIdx].people[personIdx].pos += 3
    //    }
    //     drawMan(peopleLanes[laneIdx].people[personIdx])
      
    //   if(peopleLanes[laneIdx].people[personIdx] >= WALKERS_END_POS){
    //      peopleLanes[laneIdx].people[personIdx].splice(i, 1)       
    //    }
    //   }
    // }

    // Draw cars
    for(i = 0; i < cars.length; i++){
      if(trafficRunning(timer) || (!trafficRunning(timer) && (cars[i].posX < 370))|| (cars[i].posX > 370)){
        cars[i].posX += 3
      }
      if(cars[i].vehicleType == 0)
        drawSingelCar(cars[i])
      else 
        drawSingelBike(cars[i])

      // Remove car and create new one
      if(cars[i].posX >= TRAFFIC_END_POS){
        cars.splice(i, 1)       
      }
    }
   
    // Press walk button
    if (keyboard.space)
    {
      timerStarted = true;
    }
      
    if (timerStarted == true)
    {
      timer += 1;
    }

    walkSign = getWalkSign(timer) 
    trafficSign = getTrafficSign(timer)
    picture(totalWidth-70,0,trafficSign)
    picture(0,0,walkSign)

    if (timer == 900)
    {
      timerStarted = false;
      timer = 0
    }
  }

function getRandomColor() {
  return randomColor()
  /*var letters = '0123456789ABCDEF';
  var color = '#';
  for (var i = 0; i < 6; i++) {
    color += letters[Math.floor(Math.random() * 16)];
  }
  return color;*/
}
 function trafficRunning(timer)
 {
    if(timer < 60){      
      return true
    }else{      
      return false
    }
 }

 function walkOk(timer)
 {
    if(timer >= 250 && timer < 520){      
      return true
    }else{
      
      return false
    }
 }


  function getTrafficSign(timer)
  {

    // Show yellow sign after a short while from button has been pressed and show it for 
    if ((timer > 60 && timer < 120) || (timer >= 800))
    {
        return "http://koda.nu/bilder/iis/trafikljus/light_yellow.png"
    } 

    // Show red sign after yellow sign and show it for 
    if (timer >= 120 && timer < 800)
    {
        return "http://koda.nu/bilder/iis/trafikljus/light_red.png"
    }
    return "http://koda.nu/bilder/iis/trafikljus/light_green.png"
  }

  function getWalkSign(timer)
  {
    if (timer >= 250 && timer < 520)
    {
      return "http://koda.nu/bilder/iis/trafikljus/walk_green.png"
    }else 
      return "http://koda.nu/bilder/iis/trafikljus/walk_red.png"
  }
  function getLanePos(laneNo)
  {
    switch (laneNo) {
      case 0:
        return FIRST_LANE_POS
        break;
      case 1:
        return FIRST_LANE_POS+LANE_WIDTH
        break;  
      case 2:
        return FIRST_LANE_POS+LANE_WIDTH*2
        break;  
      case 3:
        return FIRST_LANE_POS+LANE_WIDTH*3
        break;  
      case 4:
        return FIRST_LANE_POS+LANE_WIDTH*4
        break;  
      default:
        return -1
        break;
    }
  }
  function getWalkingLanePos(laneNo)
  {
    switch (laneNo) {
      case 0:
        return FIRST_WALKING_LANE_POS
        break;
      case 1:
        return FIRST_WALKING_LANE_POS+WALKING_LANE_WIDTH
        break;  
      case 2:
        return FIRST_WALKING_LANE_POS+WALKING_LANE_WIDTH*2
        break;  
      case 3:
        return FIRST_WALKING_LANE_POS+WALKING_LANE_WIDTH*3
        break;  
      case 4:
        return FIRST_WALKING_LANE_POS+WALKING_LANE_WIDTH*4
        break;  
      default:
        return -1
        break;
    }
  }
  function drawSingelCar(car)
  {
    lanePos = getLanePos(car.lane)
    rectangle(car.posX,lanePos+20,80,60,car.color)
    rectangle(car.posX+50,lanePos+30,30,30,"lightblue")
    circle(car.posX+20,lanePos+80,13,"black")
    circle(car.posX+60,lanePos+80,13,"black")
    //  if(DEBUG)
        // text (car.posX, lanePos, 20, "car.posX " + car.posX, "red")
        // text (car.posX-20, lanePos+20, 20, "car.posY " + lanePos, "black")
  }
  function drawMan(man)
  {
    lanePos = getWalkingLanePos(man.lane)
    rectangle(lanePos+53,man.pos+5,50,28,man.color)
    rectangle(lanePos+48,man.pos+8,62,20,man.color)
    circle(lanePos+78,man.pos+20,20,"black")
    circle(lanePos+78,man.pos+20,10,"gray") 
    // if(DEBUG)
    //   text (lanePos, man.pos, 20, man.pos, "red")
  }

  function drawPerson(man)
  {    
    rectangle(man.posX+53,man.posY+5,50,28,man.color)
    rectangle(man.posX+48,man.posY+8,62,20,man.color)
    circle(man.posX+78,man.posY+20,20,"black")
    circle(man.posX+78,man.posY+20,10,"gray") 
    //  if(DEBUG)
    //    text (man.posX, man.posY, 20, "man.posX"  + man.posX, "red")
    //    text (man.posX, man.posY-20, 20, "man.posY " + man.posY, "black")
  }
  function drawSingelBike(car)
  {
    lanePos = getLanePos(car.lane)
    rectangle(car.posX+10,lanePos+40,60,20,car.color)
    rectangle(car.posX+25,lanePos+20,30,20,car.color)
    
    circle(car.posX+20,lanePos+60,13,"black")
    circle(car.posX+60,lanePos+60,13,"black")
    //  if(DEBUG)
        // text (car.posX, lanePos, 20, "car.posX " + car.posX, "red")
        // text (car.posX-20, lanePos+20, 20, "car.posY " + lanePos, "black")
  }
</script>


<body>
</body>
</html>