<html>
<head>
</head>
<script src="http://koda.nu/simple.js">

    
  var a = 60;
  var timer = 0;
  var timerStarted = false;
  const FIRST_LANE_POS = 270
  const LANE_WIDTH = 170
  const FIRST_WALKING_LANE_POS = 520
  const WALKING_LANE_WIDTH = 70

  const DEBUG = true
  const TRAFFIC_START_POS = 250
  const WALKER_START_POS = 10
  const TRAFFIC_END_POS = 1110
  const WALKERS_END_POS = 1210
  var ticker = TRAFFIC_START_POS
  var carDistanceTimer = 100
  var generateCars = 0
  var generatePeople = 40
  var initiated = false
  if(DEBUG)
    text (100, 200, 20, timer, "red")
  
  var cars = new Array()
  var people = new Array()
  var lanes = new Array()
  var peopleLanes = new Array()
 

  function update()
  {
    picture(0,0, "http://koda.nu/bilder/iis/trafikljus/street.png", totalWidth, totalHeight);
    picture()
    if(initiated == false)
    {
      // Generate traffic lanes
      for(laneIdx=0;laneIdx<5;laneIdx++){
        newLane={
          pos: FIRST_LANE_POS,
          laneIndex:laneIdx,
          generateCars:0            
        }
        lanes.push(newLane)
      }
    }
    // Generate cars for each lane
    for(laneIdx=0;laneIdx<5;laneIdx++){
      if((lanes[laneIdx].generateCars == 0) ){
        newCar = {
          color:getRandomColor(), 
          lane:laneIdx, 
          vehicleType: random(2),
          speed: random(5)+3,
          posX:TRAFFIC_START_POS  
        }; 
        var carInFront = false       
        for(p=0;p<cars.length;p++){
          if((newCar.posY == cars[p].posY) && (newCar.posX == cars[p].posX))
            carInFront = true

        }
        if(!carInFront)
          cars.push(newCar)
        lanes[laneIdx].generateCars = random(90)+50
      }else{
        lanes[laneIdx].generateCars--
      }
    }

    // Generate people
    // Create new person
    if(generatePeople == 0){
      
      var randomNumber = random(100)
      var jayWalker = false
      walkSpeed = 4
      if(randomNumber >75){
        jayWalker = true
        walkSpeed = 6
      }

      newMan = {
            color:randomColor(),
            lane:laneIdx, 
            posY:WALKER_START_POS,
            posX: 520 + random(5)*70,
            jaywalker: jayWalker,
            speed: walkSpeed
          }; 
      var personInFront = false    
      for(p=0;p<people.length;p++){
        if((newMan.posX == people[p].posX) && (newMan.posY == people[p].posY))
          personInFront = true
      }
      
      if(!personInFront)
        people.push(newMan)
      generatePeople = random(30) + 20
    }else{
      generatePeople--
    }
    // Calculate numbers in line
    var peopleInLine = 0
    for(p=0;p<people.length;p++){
      if(people[p].posY < 130)
        peopleInLine ++
    }
    if (peopleInLine > 10)
      timerStarted = true
    for(i=0;i<people.length;i++){
      // Find out if we should stop
      stop = false
      for(j=0;j<cars.length;j++){

        carPosY = getLanePos(cars[j].lane)
       // text (cars[j].posX, carPosY-20, 20, people[i].posX - cars[j].posX, "blue")
       if( (carPosY > people[i].posY  && (carPosY - people[i].posY) < 120) &&
             ((abs(people[i].posX - cars[j].posX)) < 350) ) {
            if((people[i].posX > 500) && (people[i].jaywalker))
              people[i].posX -= 1
            
        }
        if( (carPosY > people[i].posY  && (carPosY - people[i].posY) < 25) &&
             ((abs(people[i].posX - cars[j].posX)) < 120) ) {
            stop = true
        }
      }
      var personInFront = false
      if(i > 0){
        for(p=0;p<people.length;p++){
          if((people[i].posX == people[p].posX) && (p<i) && (people[p].posY - people[i].posY)<45)
            personInFront = true
        }
      }

      if(people[i].jaywalker && (!stop) || walkOk(timer) || (people[i].posY < 130 && !personInFront) || (people[i].posY > 130 && (!stop)))
        people[i].posY += people[i].speed
      
      drawPerson(people[i])
    }
    

    // Draw cars
    for(i = 0; i < cars.length; i++){
      var carInFront = false
      if(i > 0){
        for(p=0;p<cars.length;p++){
          if((cars[i].lane == cars[p].lane) && (p<i) && (cars[p].posX - cars[i].posX)<100)
            carInFront = true
            //cars[i].speed = cars[p].speed
        }
      }

      if( (trafficRunning(timer) || (!trafficRunning(timer) && (cars[i].posX < 370))|| (cars[i].posX > 370))){
        if(carInFront==false)
          cars[i].posX += cars[i].speed
        
      }
      if(cars[i].vehicleType == 0)
        drawSingelCar(cars[i])
      else 
        drawSingelBike(cars[i])

      // Remove car and create new one
      if(cars[i].posX >= TRAFFIC_END_POS){
        cars.splice(i, 1)       
      }
    }
   
    // Press walk button
    if (keyboard.space)
    {
      timerStarted = true;
    }
      
    if (timerStarted == true)
    {
      timer += 1;
    }

    walkSign = getWalkSign(timer) 
    trafficSign = getTrafficSign(timer)
    picture(totalWidth-70,0,trafficSign)
    picture(0,0,walkSign)

    if (timer == 900)
    {
      timerStarted = false;
      timer = 0
    }
  }

function getRandomColor() {
  return randomColor()
  /*var letters = '0123456789ABCDEF';
  var color = '#';
  for (var i = 0; i < 6; i++) {
    color += letters[Math.floor(Math.random() * 16)];
  }
  return color;*/
}
 function trafficRunning(timer)
 {
    if(timer < 60){      
      return true
    }else{      
      return false
    }
 }

 function walkOk(timer)
 {
    if(timer >= 250 && timer < 520){      
      return true
    }else{
      
      return false
    }
 }


  function getTrafficSign(timer)
  {

    // Show yellow sign after a short while from button has been pressed and show it for 
    if ((timer > 60 && timer < 120) || (timer >= 800))
    {
        return "http://koda.nu/bilder/iis/trafikljus/light_yellow.png"
    } 

    // Show red sign after yellow sign and show it for 
    if (timer >= 120 && timer < 800)
    {
        return "http://koda.nu/bilder/iis/trafikljus/light_red.png"
    }
    return "http://koda.nu/bilder/iis/trafikljus/light_green.png"
  }

  function getWalkSign(timer)
  {
    if (timer >= 250 && timer < 520)
    {
      return "http://koda.nu/bilder/iis/trafikljus/walk_green.png"
    }else 
      return "http://koda.nu/bilder/iis/trafikljus/walk_red.png"
  }
  function getLanePos(laneNo)
  {
    switch (laneNo) {
      case 0:
        return FIRST_LANE_POS
        break;
      case 1:
        return FIRST_LANE_POS+LANE_WIDTH
        break;  
      case 2:
        return FIRST_LANE_POS+LANE_WIDTH*2
        break;  
      case 3:
        return FIRST_LANE_POS+LANE_WIDTH*3
        break;  
      case 4:
        return FIRST_LANE_POS+LANE_WIDTH*4
        break;  
      default:
        return -1
        break;
    }
  }
  
  function drawSingelCar(car)
  {
    lanePos = getLanePos(car.lane)
    rectangle(car.posX,lanePos+20,80,60,car.color)
    rectangle(car.posX+50,lanePos+30,30,30,"lightblue")
    circle(car.posX+20,lanePos+80,13,"black")
    circle(car.posX+60,lanePos+80,13,"black")
      // if(DEBUG)
      //    text (car.posX, lanePos, 20, "car.posX " + car.posX, "red")
      //    text (car.posX-20, lanePos+20, 20, "car.posY " + lanePos, "black")
  }

  function drawPerson(man)
  {    
    rectangle(man.posX+53,man.posY+5,50,28,man.color)
    rectangle(man.posX+48,man.posY+8,62,20,man.color)
    circle(man.posX+78,man.posY+20,20,"black")
    circle(man.posX+78,man.posY+20,10,"gray") 
    //  if(DEBUG)
    //    text (man.posX, man.posY, 20, "man.posX"  + man.posX, "red")
    //    text (man.posX, man.posY-20, 20, "man.posY " + man.posY, "black")
  }
  function drawSingelBike(car)
  {
    lanePos = getLanePos(car.lane)
    rectangle(car.posX+10,lanePos+40,60,20,car.color)
    rectangle(car.posX+25,lanePos+20,30,20,car.color)
    
    circle(car.posX+20,lanePos+60,13,"black")
    circle(car.posX+60,lanePos+60,13,"black")
      // if(DEBUG)
      //    text (car.posX, lanePos, 20, "car.posX " + car.posX, "red")
      //    text (car.posX-20, lanePos+20, 20, "car.posY " + lanePos, "black")
  }
</script>


<body>
</body>
</html>