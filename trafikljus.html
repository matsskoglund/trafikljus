<html>
<head>
</head>
<script src="http://koda.nu/simple.js">

  /*
    Uppgift: Trafikljus!
    
    Det finns bilder för grön och röd gubbe:
    
    http://koda.nu/bilder/iis/trafikljus/walk_green.png
    http://koda.nu/bilder/iis/trafikljus/walk_red.png
    
    samt bilder för grönt, gult och rött ljus:
    
    http://koda.nu/bilder/iis/trafikljus/light_green.png
    http://koda.nu/bilder/iis/trafikljus/light_yellow.png
    http://koda.nu/bilder/iis/trafikljus/light_red.png
    
    Uppgift 1:
    
    Hur kan du modifiera koden nedan så att det blir grönt
    för gångare när man trycker på en knapp, och då rött för
    bilar? 

    Du kommer behöva lägga in if-satser som håller koll på 
    olika knappar på tangentbordet.
    
    Uppgift 2:
    
    Lägg till en timer som ser till så att det är
    grönt för gångarna under en viss tid, och sen kopplar det
    över till bilarna automatiskt.
    
    Uppgift 3:
    
    När man trycker på knappen för att gå över vägen så ska det inte
    bli grönt för fotgängare direkt. Först efter 5 sekunder ska det bli
    gult för bilarna. Sen efter ytterligare 5 sekunder ska det bli rött
    för bilarna och grönt för fotgängare. Fotgängarna ska få ha grönt
    i 5 sekunder, och sedan ska de få rött. Efter att de haft rött i 2 sekunder
    så ska bilarna få grönt.
    
  */
    
  var a = 60;
  var timer = 0;
  var timerStarted = false;
  const FIRST_LANE_POS = 270
  const LANE_WIDTH = 170
  const FIRST_WALKING_LANE_POS = 520
  const WALKING_LANE_WIDTH = 70

  const DEBUG = true
  const TRAFFIC_START_POS = 250
  const WALKER_START_POS = 10
  const TRAFFIC_END_POS = 1110
  const WALKERS_END_POS = 1210
  var ticker = TRAFFIC_START_POS
  var carDistanceTimer = 100
  var generateCars = 0
  var generatePeople = 40
  var initiated = false
  if(DEBUG)
    text (100, 200, 20, timer, "red")
  
  var cars = new Array()
  var people = new Array()
  var lanes = new Array()
  var peopleLanes = new Array()
  function update()
  {
    picture(0,0, "http://koda.nu/bilder/iis/trafikljus/street.png", totalWidth, totalHeight);

    if(initiated == false)
    {
      // Generate traffic lanes
      for(laneIdx=0;laneIdx<5;laneIdx++){
        newLane={
          pos: FIRST_LANE_POS,
          laneIndex:laneIdx,
          generateCars:0            
        }
        lanes.push(newLane)
      }
      // Generate people lanes
      for(laneIdx=0;laneIdx<5;laneIdx++){
        newLane={
          pos: FIRST_WALKING_LANE_POS,
          laneIndex:laneIdx,
          generatePeople:0,
          people: Array()
        }
        peopleLanes.push(newLane)
      }
      initiated = true
    }
    // Generate cars for each lane
    for(laneIdx=0;laneIdx<5;laneIdx++){
      if((lanes[laneIdx].generateCars == 0) && (trafficRunning(timer))){
        newCar = {
          color:getRandomColor(), 
          lane:laneIdx, 
          pos:TRAFFIC_START_POS  
        }; 
        cars.push(newCar)
        lanes[laneIdx].generateCars = Math.floor(Math.random() * 60 + 30 )
      }else if (trafficRunning(timer)){
        lanes[laneIdx].generateCars--
      }
    }

    // Generate people
    for(laneIdx=0; laneIdx <= 4; laneIdx++){    
      if((peopleLanes[laneIdx].generatePeople == 0) && (peopleLanes[laneIdx].people.length < 30)){
        newMan = {
          color:getRandomColor(), 
          lane:laneIdx, 
          pos:WALKER_START_POS,          
          queueNo: peopleLanes[laneIdx].people.length
        }; 
        
        people.push(newMan)

        peopleLanes[laneIdx].people.push(newMan)
        peopleLanes[laneIdx].generatePeople = Math.floor(Math.random() * 60 + 30 )
      }else{
        peopleLanes[laneIdx].generatePeople--
      }
    }
    
    // Draw cars
    for(i = 0; i < cars.length; i++){
      if(trafficRunning(timer) || (!trafficRunning(timer) && (cars[i].pos < 370))|| (cars[i].pos > 370)){
        cars[i].pos += 3
      }
      drawSingelCar(cars[i])

      // Remove car and create new one
      if(cars[i].pos >= TRAFFIC_END_POS){
        cars.splice(i, 1)       
      }
    }
   
    // Generate people
    for(laneIdx=0; laneIdx <= 4; laneIdx++){    
      for(personIdx = 0; personIdx < peopleLanes[laneIdx].people.length; personIdx++){
        if(walkOk(timer) || (!walkOk(timer) && (peopleLanes[laneIdx].people[personIdx].pos < 130) && (personIdx > 0) && (peopleLanes[laneIdx].people[personIdx].pos-130 > 0)) || (peopleLanes[laneIdx].people[personIdx].pos > 130)){
          peopleLanes[laneIdx].people[personIdx].pos += 3
       }
        drawMan(peopleLanes[laneIdx].people[personIdx])
      
      if(peopleLanes[laneIdx].people[personIdx] >= WALKERS_END_POS){
         peopleLanes[laneIdx].people[personIdx].splice(i, 1)       
       }
      }
    }

    // Draw people
    // for(i = 0; i < people.length; i++){
    //   if(walkOk(timer) || (!walkOk(timer) && (people[i].pos < 130)) || (people[i].pos > 130)){
    //     people[i].pos += 3
    //   }
    //   drawMan(people[i])

    //   // Remove person and create new one
    //   if(people[i].pos >= WALKERS_END_POS){
    //     people.splice(i, 1)       
    //   }
    // }

    if(DEBUG)
      text (200, 200, 20, cars[0].pos, "red")

    // Press walk button
    if (keyboard.space)
    {
      timerStarted = true;
    }
      
    if (timerStarted == true)
    {
      timer += 1;
    }

    walkSign = getWalkSign(timer) 
    trafficSign = getTrafficSign(timer)
    picture(totalWidth-70,0,trafficSign)
    picture(0,0,walkSign)

    if (timer == 900)
    {
      timerStarted = false;
      timer = 0
    }
  }

function getRandomColor() {
  var letters = '0123456789ABCDEF';
  var color = '#';
  for (var i = 0; i < 6; i++) {
    color += letters[Math.floor(Math.random() * 16)];
  }
  return color;
}
 function trafficRunning(timer)
 {
    if(timer < 60){      
      return true
    }else{      
      return false
    }
 }

 function walkOk(timer)
 {
    if(timer >= 250 && timer < 520){      
      return true
    }else{
      
      return false
    }
 }


  function getTrafficSign(timer)
  {

    // Show yellow sign after a short while from button has been pressed and show it for 
    if ((timer > 60 && timer < 120) || (timer >= 800))
    {
        return "http://koda.nu/bilder/iis/trafikljus/light_yellow.png"
    } 

    // Show red sign after yellow sign and show it for 
    if (timer >= 120 && timer < 800)
    {
        return "http://koda.nu/bilder/iis/trafikljus/light_red.png"
    }
    return "http://koda.nu/bilder/iis/trafikljus/light_green.png"
  }

  function getWalkSign(timer)
  {
    if (timer >= 250 && timer < 520)
    {
      return "http://koda.nu/bilder/iis/trafikljus/walk_green.png"
    }else 
      return "http://koda.nu/bilder/iis/trafikljus/walk_red.png"
  }
  function getLanePos(laneNo)
  {
    switch (laneNo) {
      case 0:
        return FIRST_LANE_POS
        break;
      case 1:
        return FIRST_LANE_POS+LANE_WIDTH
        break;  
      case 2:
        return FIRST_LANE_POS+LANE_WIDTH*2
        break;  
      case 3:
        return FIRST_LANE_POS+LANE_WIDTH*3
        break;  
      case 4:
        return FIRST_LANE_POS+LANE_WIDTH*4
        break;  
      default:
        return -1
        break;
    }
  }
  function getWalkingLanePos(laneNo)
  {
    switch (laneNo) {
      case 0:
        return FIRST_WALKING_LANE_POS
        break;
      case 1:
        return FIRST_WALKING_LANE_POS+WALKING_LANE_WIDTH
        break;  
      case 2:
        return FIRST_WALKING_LANE_POS+WALKING_LANE_WIDTH*2
        break;  
      case 3:
        return FIRST_WALKING_LANE_POS+WALKING_LANE_WIDTH*3
        break;  
      case 4:
        return FIRST_WALKING_LANE_POS+WALKING_LANE_WIDTH*4
        break;  
      default:
        return -1
        break;
    }
  }
  function drawSingelCar(car)
  {
    lanePos = getLanePos(car.lane)
    rectangle(car.pos,lanePos+20,80,60,car.color)
    rectangle(car.pos+50,lanePos+30,30,30,"lightblue")
    circle(car.pos+20,lanePos+80,13,"black")
    circle(car.pos+60,lanePos+80,13,"black")
  }
  function drawMan(man)
  {
    lanePos = getWalkingLanePos(man.lane)
    rectangle(lanePos+53,man.pos+5,50,28,man.color)
    rectangle(lanePos+48,man.pos+8,62,20,man.color)
    circle(lanePos+78,man.pos+20,20,"black")
    circle(lanePos+78,man.pos+20,10,"gray")   
  }

  function drawbike(pos,color)
  {
    rectangle(pos,45,80,40,color)
    rectangle(pos+48,25,30,30,"lightblue")
    circle(pos+20,80,13,"black")
    circle(pos+60,80,13,"black")
  }
</script>


<body>
</body>
</html>